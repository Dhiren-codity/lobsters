
prep
x turn down DNS ttl
x connect repo
x stand up web03 in hatchbox
x add DATABASE_URL
x copy SECRET_KEY_BASE
x DO vpc peering
x db01 firewall mariadb from anything except web03; ansible changed mariadb to listen to all
x dnsimple: losbters.dev A -> web03
x bump svg-graph
x update prod log path
x hatchbox custom pre-build script:
    cp /home/deploy/lobsters/shared/credentials.enc.yml config/credentials.enc.yml
    cp /home/deploy/lobsters/shared/master.key config/master.key
    cp /home/deploy/lobsters/shared/database.yml config/database.yml
x big blue deploy button
x sidequest: mariadb recovery scare
x initialize queue and cache dbs
    queue and cache dbs had wrong path so hatchbox didn't initalize them
    initializing failed because of an activerecord bug https://github.com/rails/rails/issues/50672
    workaround worked https://github.com/rails/solid_queue/issues/365#issuecomment-2548639056
x test puma from web03: curl http://127.0.0.1:9000/about
x hatchbox add job worker process to 'worker' role: bundle exec rails solid_queue:start
    systemctl status lobsters-solid_queue --user -M deploy@
    sudo -u deploy journalctl --user --user-unit=lobsters-solid_queue
x doublecheck that /stats is still good
x hatchbox test maintenance page
x locate Caddyfile: visible in activity -> 'Apps::Caddy' -> Server Logs
x understand logrotate config: /etc/logrotate.d/hatchbox_logrotate.conf rotate daily, keep 7 (eek!)
x turn off/firewall yoeng.hatchboxapp.com
x configure caddy to serve avatars
x telebugs works?
x configure caddy to serve from full-page cache wo cookies https://app.hatchbox.io/clusters/7952/settings
x caddy move to imoprt
x hatchbox app pre-script setting: hatchbox/pre-build
x locate rails default logger: stdout to journald
x locate lograge logs: ~/lobsters/shared/log/action.log
x get caddy logging to shared/log
x locate solid_queue log
x confirm unattended upgrades
x puma worker count is 3?? doublecheck nateperkopec recent skeets
x cron jobs https://app.hatchbox.io/apps/10006/cron_jobs/new
x service to hook deploys:
x   logrotate config to override hatchbox
x   bare minimum shell config from lobsters-ansible
x   postfix send email
x   /etc restic
x recurring task for app restic
  DO: reserve IP

setup:
  # ln -s /home/deploy/lobsters/current/hatchbox/root-deploy.service /etc/systemd/system
  # ln -s /home/deploy/lobsters/current/hatchbox/root-deploy.path /etc/systemd/system
  # systemctl daemon-reload
  # systemctl enable root-deploy.service
  # systemctl enable root-deploy.path
  # systemctl start root-deploy.service
  # systemctl start root-deploy.path

changeover
  merge hatchbox -> master, update hatchbox deploy branch
  web01 enable read-only
  change over DNS for lobste.rs
  web03 disable read-only
  web03 write our redirect from lobsters.dev -> lobste.rs
  DO rename web03 -> lobste.rs I bet
  dnsimple: lobsters.dev A, AAAA -> web03
  hatchbox web ui: uncomment lobsters-cron job to run every 5m
  merge down hatchbox branch
  update hatchbox to deploy master branch
  turn up DNS ttl to 3600
  write up notes to setup instructions
  test postfix outgoing
  test postfix incoming

later
  archive lobsters-ansible
  tune config/puma thread count based on prod usage
  idea: logs -> DO durable obj -> duckdb?

note:
  to update caddy files, deploy them, then go to app settings and click 'Update Caddy' to pick up the change
